<section class="split">
  <aside class="card sidebar">
    <div class="pad">
      <div class="h2">Filters</div>
      <form action="/marketplace" method="GET">
        <% if (query) { %>
          <input type="hidden" name="q" value="<%= query %>" />
        <% } %>
        
        <div class="field">
          <label>Asset type</label>
          <select name="type" onchange="this.form.submit()">
            <option value="all" <%= filters.type === 'all' ? 'selected' : '' %>>All Types</option>
            <option value="raw_material" <%= filters.type === 'raw_material' ? 'selected' : '' %>>Raw Materials</option>
            <option value="finished_part" <%= filters.type === 'finished_part' ? 'selected' : '' %>>Finished Parts</option>
            <option value="equipment" <%= filters.type === 'equipment' ? 'selected' : '' %>>Equipment</option>
            <option value="service" <%= filters.type === 'service' ? 'selected' : '' %>>Services</option>
          </select>
        </div>

        <div class="row" style="margin-top: 12px">
          <div class="field" style="flex: 1">
            <label>Location</label>
            <select name="location" onchange="this.form.submit()">
              <option value="all" <%= filters.location === 'all' ? 'selected' : '' %>>All Ontario</option>
              <option value="Toronto" <%= filters.location === 'Toronto' ? 'selected' : '' %>>GTA / Toronto</option>
              <option value="Hamilton" <%= filters.location === 'Hamilton' ? 'selected' : '' %>>Hamilton</option>
              <option value="Cambridge" <%= filters.location === 'Cambridge' ? 'selected' : '' %>>Cambridge</option>
              <option value="Kitchener" <%= filters.location === 'Kitchener' ? 'selected' : '' %>>Kitchener-Waterloo</option>
              <option value="Mississauga" <%= filters.location === 'Mississauga' ? 'selected' : '' %>>Mississauga</option>
            </select>
          </div>
        </div>

        <div class="field" style="margin-top: 12px">
          <label>NAFTA Content (%)</label>
          <div style="display: flex; align-items: center; gap: 12px;">
            <input 
              type="range" 
              name="naftaContent" 
              id="naftaContentSlider"
              min="0" 
              max="100" 
              value="<%= filters.naftaContent !== undefined ? filters.naftaContent : 0 %>"
              oninput="document.getElementById('naftaContentValue').textContent = this.value + '%'; this.form.submit();"
              style="flex: 1;"
            />
            <span id="naftaContentValue" style="min-width: 45px; text-align: right; font-size: 13px; color: var(--muted);">
              <%= filters.naftaContent !== undefined ? filters.naftaContent : 0 %>%</span>
          </div>
        </div>

        <div class="field" style="margin-top: 12px">
          <label>Verification</label>
          <select name="verification" onchange="this.form.submit()">
            <option value="any" <%= filters.verification === 'any' ? 'selected' : '' %>>Any</option>
            <option value="document_supported" <%= filters.verification === 'document_supported' ? 'selected' : '' %>>Document-Supported+</option>
            <option value="fully_verified" <%= filters.verification === 'fully_verified' ? 'selected' : '' %>>Fully Verified+</option>
          </select>
        </div>

        <div class="field" style="margin-top: 12px">
          <label>Intellectual Property</label>
          <div style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; padding: 8px; border: 1px solid var(--border); border-radius: 12px; background: rgba(255, 255, 255, 0.03);">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="ip" value="Patent" onchange="this.form.submit()" <%= filters.intellectualProperty && filters.intellectualProperty.includes('Patent') ? 'checked' : '' %> />
              <span>Patent</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="ip" value="License" onchange="this.form.submit()" <%= filters.intellectualProperty && filters.intellectualProperty.includes('License') ? 'checked' : '' %> />
              <span>License</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="ip" value="Trademark" onchange="this.form.submit()" <%= filters.intellectualProperty && filters.intellectualProperty.includes('Trademark') ? 'checked' : '' %> />
              <span>Trademark</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="ip" value="Trade Secret" onchange="this.form.submit()" <%= filters.intellectualProperty && filters.intellectualProperty.includes('Trade Secret') ? 'checked' : '' %> />
              <span>Trade Secret</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="ip" value="Copyright" onchange="this.form.submit()" <%= filters.intellectualProperty && filters.intellectualProperty.includes('Copyright') ? 'checked' : '' %> />
              <span>Copyright</span>
            </label>
          </div>
        </div>

        <div class="field" style="margin-top: 12px">
          <label>Shop Compliance</label>
          <div style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; padding: 8px; border: 1px solid var(--border); border-radius: 12px; background: rgba(255, 255, 255, 0.03);">
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="ISO 9001:2015" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('ISO 9001:2015') ? 'checked' : '' %> />
              <span>ISO 9001:2015</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="ISO 14001" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('ISO 14001') ? 'checked' : '' %> />
              <span>ISO 14001</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="ISO 45001" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('ISO 45001') ? 'checked' : '' %> />
              <span>ISO 45001</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="ISO 13485" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('ISO 13485') ? 'checked' : '' %> />
              <span>ISO 13485</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="ISO/TS 22163" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('ISO/TS 22163') ? 'checked' : '' %> />
              <span>ISO/TS 22163</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="ISO 17024" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('ISO 17024') ? 'checked' : '' %> />
              <span>ISO 17024</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="CWB" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('CWB') ? 'checked' : '' %> />
              <span>CWB</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="AS9100D" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('AS9100D') ? 'checked' : '' %> />
              <span>AS9100D</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="HACCP" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('HACCP') ? 'checked' : '' %> />
              <span>HACCP</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="FSSC 22000" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('FSSC 22000') ? 'checked' : '' %> />
              <span>FSSC 22000</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="21 CFR Part 11" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('21 CFR Part 11') ? 'checked' : '' %> />
              <span>21 CFR Part 11</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="B-Corporation" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('B-Corporation') ? 'checked' : '' %> />
              <span>B-Corporation</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="Fair Trade" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('Fair Trade') ? 'checked' : '' %> />
              <span>Fair Trade</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
              <input type="checkbox" name="compliance" value="Organic" onchange="this.form.submit()" <%= filters.shopCompliance && filters.shopCompliance.includes('Organic') ? 'checked' : '' %> />
              <span>Organic</span>
            </label>
          </div>
        </div>

        <noscript>
          <button type="submit" class="btn block" style="margin-top: 14px">Apply Filters</button>
        </noscript>
      </form>

      <div class="notice" style="margin-top: 14px">
        <strong><%= dpps.length %></strong> listing<%= dpps.length !== 1 ? 's' : '' %> found
      </div>
    </div>
  </aside>

  <section class="grid" style="gap: 18px">
    <div class="card">
      <div class="pad">
        <div class="row" style="align-items: flex-end">
          <div class="field" style="flex: 1">
            <label for="queryBox">Search</label>
            <form action="/marketplace" method="GET" style="display: flex; gap: 10px;">
              <input
                id="queryBox"
                name="q"
                class="input"
                placeholder="Search materials, equipment, services…"
                value="<%= query %>"
              />
              <button type="submit" class="btn primary">Search</button>
            </form>
          </div>
          <div style="display: flex; gap: 10px; align-items: center">
            <a class="btn good" href="/ai/recommend<%= query ? '?q=' + encodeURIComponent(query) : '' %>">AI Suggestions</a>
          </div>
        </div>
        <% if (query) { %>
          <div class="p" style="margin-top: 10px">Showing results for: "<strong><%= query %></strong>"</div>
        <% } else { %>
          <div class="p" style="margin-top: 10px">Showing all listings</div>
        <% } %>
      </div>
    </div>

    <% if (dpps.length === 0) { %>
      <div class="card">
        <div class="pad empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21l-4.35-4.35"/>
          </svg>
          <div class="h3">No listings found</div>
          <p class="p">Try adjusting your search or filters</p>
        </div>
      </div>
    <% } else { %>
      <div class="grid cols-3">
        <% dpps.forEach(dpp => { %>
        <a class="card" href="/dpp/<%= dpp.id %>">
          <div class="pad">
            <div class="cardHeader">
              <div>
                <div class="h3"><%= dpp.name %></div>
                <p class="p"><%= dpp.seller?.name %> • <%= dpp.seller?.location %></p>
              </div>
              <% if (dpp.verification?.tier === 'fully_verified') { %>
                <span class="badge verified">Fully Verified</span>
              <% } else if (dpp.verification?.tier === 'document_supported') { %>
                <span class="badge warn">Doc-Supported</span>
              <% } else { %>
                <span class="badge basic">Basic</span>
              <% } %>
            </div>
            <div class="p" style="margin-top: 10px">
              <% if (dpp.specs?.material) { %>
                <%= dpp.specs.material %>
              <% } else if (dpp.specs?.make) { %>
                <%= dpp.specs.make %> <%= dpp.specs.model %> (<%= dpp.specs.year %>)
              <% } else if (dpp.specs?.capabilities) { %>
                <%= dpp.specs.capabilities %>
              <% } else { %>
                <%= dpp.description?.substring(0, 100) %>...
              <% } %>
            </div>
            <% if (dpp.intellectualProperty && dpp.intellectualProperty.length > 0) { %>
              <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px;">
                <% dpp.intellectualProperty.forEach(ip => { %>
                  <span class="badge" style="font-size: 11px; padding: 4px 8px;">IP: <%= ip %></span>
                <% }); %>
              </div>
            <% } %>
            <% if (dpp.shopCompliance && dpp.shopCompliance.length > 0) { %>
              <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                <% dpp.shopCompliance.forEach(comp => { %>
                  <span class="badge verified" style="font-size: 11px; padding: 4px 8px;"><%= comp %></span>
                <% }); %>
              </div>
            <% } %>
            <div class="row" style="margin-top: 12px; align-items: center; justify-content: space-between">
              <% if (dpp.nafta?.qualifies) { %>
                <span class="badge verified">NAFTA: <%= dpp.nafta.rvc %>%</span>
              <% } else if (dpp.availability?.status === 'in_stock') { %>
                <span class="badge">In Stock</span>
              <% } else { %>
                <span class="badge">Lead: <%= dpp.availability?.leadTimeDays || '?' %> days</span>
              <% } %>
              <span class="badge">
                <%= dpp.pricing?.currency || 'CAD' %> $<%= dpp.pricing?.basePrice?.toLocaleString() || '0' %>
                <% if (dpp.pricing?.unit) { %>/<%= dpp.pricing.unit %><% } %>
              </span>
            </div>
          </div>
        </a>
        <% }); %>
      </div>
    <% } %>
  </section>
</section>


