<section class="grid" style="gap: 18px">
  <div class="card">
    <div class="pad">
      <div class="row" style="align-items: flex-start; justify-content: space-between">
        <div>
          <div class="kicker">NAFTA / CUSMA Content Breakdown</div>
          <h2 class="h2" style="margin-top: 10px">DPP: <%= dpp.name %></h2>
          <p class="p">Input-by-input origin tracking with automatic RVC calculation.</p>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px">
            <% if (dpp.nafta?.qualifies) { %>
              <span class="badge verified">RVC: <%= dpp.nafta.rvc %>% • Qualifies</span>
            <% } else if (dpp.nafta?.rvc !== null) { %>
              <span class="badge danger">RVC: <%= dpp.nafta.rvc %>% • Does Not Qualify</span>
            <% } else { %>
              <span class="badge">RVC: Not calculated</span>
            <% } %>
            <span class="badge">Method: Transaction Value</span>
            <span class="badge">Threshold: 60%</span>
          </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 220px">
          <form action="/nafta/<%= dpp.id %>/calculate" method="POST">
            <button type="submit" class="btn primary block">Recalculate RVC</button>
          </form>
          <% if (dpp.nafta?.qualifies) { %>
            <a class="btn good block" href="/nafta/<%= dpp.id %>/certificate">Generate Certificate</a>
          <% } else { %>
            <button class="btn block" disabled title="DPP must qualify to generate certificate">Generate Certificate</button>
          <% } %>
          <a class="btn block" href="/dpp/<%= dpp.id %>">Back to DPP</a>
        </div>
      </div>
    </div>
  </div>

  <div class="grid cols-2">
    <div class="card">
      <div class="pad">
        <div class="h2">Country Breakdown</div>
        <% if (dpp.nafta?.breakdown) { %>
          <div class="grid" style="gap: 12px">
            <div class="card" style="box-shadow: none">
              <div class="pad sm" style="display: flex; justify-content: space-between; align-items: center">
                <div>
                  <div class="h3">Canada</div>
                  <div class="p">Direct labor, overhead, Canadian materials</div>
                </div>
                <div class="badge verified"><%= dpp.nafta.breakdown.canada %>%</div>
              </div>
            </div>
            <div class="card" style="box-shadow: none">
              <div class="pad sm" style="display: flex; justify-content: space-between; align-items: center">
                <div>
                  <div class="h3">USA</div>
                  <div class="p">US-origin materials and components</div>
                </div>
                <div class="badge"><%= dpp.nafta.breakdown.usa %>%</div>
              </div>
            </div>
            <div class="card" style="box-shadow: none">
              <div class="pad sm" style="display: flex; justify-content: space-between; align-items: center">
                <div>
                  <div class="h3">Mexico</div>
                  <div class="p">Mexican-origin materials</div>
                </div>
                <div class="badge"><%= dpp.nafta.breakdown.mexico %>%</div>
              </div>
            </div>
            <div class="card" style="box-shadow: none">
              <div class="pad sm" style="display: flex; justify-content: space-between; align-items: center">
                <div>
                  <div class="h3">Other</div>
                  <div class="p">Non-NAFTA inputs</div>
                </div>
                <div class="badge <%= dpp.nafta.breakdown.other > 40 ? 'danger' : 'warn' %>"><%= dpp.nafta.breakdown.other %>%</div>
              </div>
            </div>
          </div>
        <% } else { %>
          <div class="notice">Add inputs below to see country breakdown.</div>
        <% } %>

        <div class="notice" style="margin-top: 12px">
          <strong>NAFTA/CUSMA Rule:</strong> Product must have ≥60% Regional Value Content (RVC) to qualify for preferential tariff treatment.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="pad">
        <div class="h2">Inputs</div>
        <% if (inputs && inputs.length > 0) { %>
          <table class="table" aria-label="NAFTA inputs table">
            <tr>
              <th>Input</th>
              <th>Category</th>
              <th>Country</th>
              <th>Cost</th>
              <th></th>
            </tr>
            <% inputs.forEach(input => { %>
              <tr>
                <td><%= input.name %></td>
                <td><%= input.category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) %></td>
                <td><%= input.country %></td>
                <td>$<%= input.cost.toFixed(2) %></td>
                <td>
                  <form action="/nafta/inputs/<%= input.id %>/delete" method="POST" style="display: inline">
                    <input type="hidden" name="dppId" value="<%= dpp.id %>" />
                    <button type="submit" class="btn small danger" onclick="return confirm('Delete this input?')">×</button>
                  </form>
                </td>
              </tr>
            <% }); %>
          </table>
        <% } else { %>
          <div class="notice">No inputs added yet. Add your first input below.</div>
        <% } %>

        <div style="margin-top: 16px">
          <div class="h3" style="margin-bottom: 12px">Add Input</div>
          <form action="/nafta/<%= dpp.id %>/inputs" method="POST">
            <div class="form-grid cols-2">
              <div class="field">
                <label for="inputName">Input Name</label>
                <input type="text" id="inputName" name="name" class="input" required
                  placeholder="e.g., Raw material, Labor" />
              </div>
              <div class="field">
                <label for="inputCategory">Category</label>
                <select id="inputCategory" name="category" class="input" required>
                  <option value="raw_material">Raw Material</option>
                  <option value="direct_labor">Direct Labor</option>
                  <option value="overhead">Overhead</option>
                  <option value="packaging">Packaging</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="field">
                <label for="inputCountry">Country of Origin</label>
                <select id="inputCountry" name="country" class="input" required>
                  <option value="CAN">Canada (CAN)</option>
                  <option value="USA">United States (USA)</option>
                  <option value="MEX">Mexico (MEX)</option>
                  <option value="CHN">China (CHN)</option>
                  <option value="DEU">Germany (DEU)</option>
                  <option value="JPN">Japan (JPN)</option>
                  <option value="KOR">South Korea (KOR)</option>
                  <option value="TWN">Taiwan (TWN)</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
              <div class="field">
                <label for="inputCost">Cost ($)</label>
                <input type="number" id="inputCost" name="cost" class="input" step="0.01" required
                  placeholder="0.00" />
              </div>
            </div>
            <button type="submit" class="btn primary" style="margin-top: 12px">Add Input</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>


