<section class="split">
  <aside class="card sidebar">
    <div class="pad">
      <div class="h2">Inbox</div>
      
      <% if (threads && threads.length > 0) { %>
        <div class="grid" style="gap: 12px; margin-top: 14px">
          <% threads.forEach(thread => { %>
            <a class="card" href="/messages/thread/<%= thread.id %>" 
               style="box-shadow: none; <%= activeThread?.id === thread.id ? 'border-color: var(--brand);' : '' %>">
              <div class="pad sm">
                <div class="cardHeader">
                  <div>
                    <div class="h3"><%= thread.otherUser?.name || 'Unknown User' %> • <%= thread.otherUser?.company || '' %></div>
                    <div class="p">Re: <%= thread.dpp?.name || 'Unknown DPP' %></div>
                  </div>
                  <% if (thread.unreadCount > 0) { %>
                    <span class="badge verified">New</span>
                  <% } else if (thread.lastMessage) { %>
                    <span class="badge"><%= new Date(thread.lastMessage.createdAt).toLocaleDateString() %></span>
                  <% } %>
                </div>
              </div>
            </a>
          <% }); %>
        </div>
      <% } else { %>
        <div class="notice" style="margin-top: 14px">
          No conversations yet. Contact a seller from a DPP listing to start a conversation.
        </div>
      <% } %>

      <div class="notice" style="margin-top: 14px">
        <strong>MVP Note:</strong> Transactions are completed off-platform. Messaging is for introductions + spec clarification.
      </div>
    </div>
  </aside>

  <section class="grid" style="gap: 18px">
    <% if (activeThread) { %>
      <div class="card">
        <div class="pad">
          <div class="row" style="align-items: flex-start; justify-content: space-between">
            <div>
              <div class="kicker">Conversation</div>
              <h2 class="h2" style="margin-top: 10px">
                <%= activeThread.participants?.find(p => p?.id !== currentUserId)?.name || 'Contact' %> • 
                <%= activeThread.participants?.find(p => p?.id !== currentUserId)?.company || '' %>
              </h2>
              <p class="p">Topic: <%= activeThread.dpp?.name || 'Unknown' %></p>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap">
              <a class="btn" href="/dpp/<%= activeThread.dppId %>">Open DPP</a>
              <button class="btn js-demo" data-action="Share Contact" data-msg="In production, you can securely share phone/email after acceptance.">Share Contact</button>
            </div>
          </div>
        </div>
      </div>

      <div id="thread" class="grid" style="gap: 12px">
        <% if (activeThread.messages && activeThread.messages.length > 0) { %>
          <% activeThread.messages.forEach(msg => { %>
            <div class="card <%= msg.fromUserId === currentUserId ? 'message-bubble self' : '' %>">
              <div class="pad sm">
                <div class="h3" style="margin-bottom: 2px">
                  <% const sender = activeThread.participants?.find(p => p?.id === msg.fromUserId); %>
                  <%= msg.fromUserId === currentUserId ? 'You' : (sender?.name || 'Unknown') %>
                </div>
                <div class="p" style="color: #dbe7ff"><%= msg.content %></div>
                <div class="p" style="font-size: 12px; margin-top: 8px">
                  <%= new Date(msg.createdAt).toLocaleString() %>
                </div>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="notice">No messages in this conversation yet.</div>
        <% } %>
      </div>

      <div class="card">
        <div class="pad">
          <form action="/messages/thread/<%= activeThread.id %>" method="POST">
            <div class="row" style="align-items: flex-end">
              <div class="field" style="flex: 1">
                <label for="msgBox">Write a message</label>
                <input id="msgBox" name="content" class="input" placeholder="Type your message…" required />
              </div>
              <div style="display: flex; gap: 10px">
                <button class="btn js-demo" data-action="Attach file" data-msg="File attachments coming in Phase 2.">Attach</button>
                <button type="submit" class="btn primary">Send</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    <% } else { %>
      <div class="card">
        <div class="pad empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <div class="h3">Select a conversation</div>
          <p class="p">Choose a conversation from the inbox or contact a seller from a listing.</p>
        </div>
      </div>
    <% } %>
  </section>
</section>


