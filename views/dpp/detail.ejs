<section class="grid" style="gap: 18px">
  <div class="card">
    <div class="pad">
      <div class="row" style="align-items: flex-start; justify-content: space-between">
        <div>
          <div class="kicker">Digital Product Passport (DPP) • <%= dpp.assetType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) %></div>
          <div style="display: flex; align-items: baseline; gap: 16px; flex-wrap: wrap; margin-top: 10px">
            <h2 class="h2" style="margin: 0"><%= dpp.name %></h2>
            <% if (dpp.specs?.hsCode) { %>
              <div style="font-size: 16px; color: #f59e0b; font-weight: 600; white-space: nowrap">
                HTS (HS) Code: <%= dpp.specs.hsCode %>
              </div>
            <% } %>
          </div>
          <p class="p"><%= dpp.seller?.name %> • <%= dpp.seller?.location %></p>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px">
            <% if (dpp.verification?.tier === 'fully_verified') { %>
              <span class="badge verified">Fully Verified</span>
            <% } else if (dpp.verification?.tier === 'document_supported') { %>
              <span class="badge warn">Document-Supported</span>
            <% } else { %>
              <span class="badge basic">Basic</span>
            <% } %>
            <% if (dpp.nafta?.qualifies) { %>
              <span class="badge verified">NAFTA: RVC <%= dpp.nafta.rvc %>% • Qualifies</span>
            <% } else if (dpp.nafta?.enabled) { %>
              <span class="badge danger">NAFTA: Does Not Qualify</span>
            <% } %>
            <span class="badge">
              <%= dpp.pricing?.currency || 'CAD' %> $<%= dpp.pricing?.basePrice?.toLocaleString() || '0' %>
              <% if (dpp.pricing?.unit) { %> / <%= dpp.pricing.unit %><% } %>
            </span>
          </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 220px">
          <a class="btn primary" href="/messages/contact/<%= dpp.id %>">Contact Seller</a>
          <% if (dpp.nafta?.enabled) { %>
            <a class="btn" href="/nafta/<%= dpp.id %>">View NAFTA/CUSMA</a>
          <% } %>
          <a class="btn good" href="/ai/recommend?q=<%= encodeURIComponent((dpp.specs?.material || dpp.name) + ' ' + (dpp.specs?.maxTemp ? dpp.specs.maxTemp + 'F' : '')) %>">AI Analysis</a>
        </div>
      </div>
      <div class="notice" style="margin-top: 14px">
        <strong>Description:</strong> <%= dpp.description %>
      </div>
    </div>
  </div>

  <div class="grid cols-2">
    <div class="card">
      <div class="pad">
        <div class="h2">Specifications</div>
        <table class="table" aria-label="Specifications table">
          <% if (dpp.specs?.material) { %>
            <tr><th>Material</th><td><%= dpp.specs.material %></td></tr>
          <% } %>
          <% if (dpp.specs?.form) { %>
            <tr><th>Form</th><td><%= dpp.specs.form %></td></tr>
          <% } %>
          <% if (dpp.specs?.dimensions) { %>
            <tr><th>Dimensions</th><td><%= dpp.specs.dimensions %></td></tr>
          <% } %>
          <% if (dpp.specs?.weight) { %>
            <tr><th>Quantity/Weight</th><td><%= dpp.specs.weight %></td></tr>
          <% } %>
          <% if (dpp.specs?.make) { %>
            <tr><th>Make/Model</th><td><%= dpp.specs.make %> <%= dpp.specs.model %></td></tr>
          <% } %>
          <% if (dpp.specs?.year) { %>
            <tr><th>Year</th><td><%= dpp.specs.year %></td></tr>
          <% } %>
          <% if (dpp.specs?.hours) { %>
            <tr><th>Hours</th><td><%= dpp.specs.hours?.toLocaleString() %></td></tr>
          <% } %>
          <% if (dpp.specs?.capabilities) { %>
            <tr><th>Capabilities</th><td><%= dpp.specs.capabilities %></td></tr>
          <% } %>
          <% if (dpp.specs?.capacity) { %>
            <tr><th>Capacity</th><td><%= dpp.specs.capacity %></td></tr>
          <% } %>
          <% if (dpp.specs?.hsCode) { %>
            <tr><th>HS Code</th><td><%= dpp.specs.hsCode %></td></tr>
          <% } %>
          <tr><th>Availability</th><td>
            <% if (dpp.availability?.status === 'in_stock') { %>
              In Stock (<%= dpp.availability.quantity?.toLocaleString() %> <%= dpp.pricing?.unit || 'units' %>)
            <% } else { %>
              Made to Order
            <% } %>
          </td></tr>
          <tr><th>Lead Time</th><td><%= dpp.availability?.leadTimeDays || '?' %> days</td></tr>
          <% if (dpp.availability?.minimumOrder) { %>
            <tr><th>Min. Order</th><td><%= dpp.availability.minimumOrder %> <%= dpp.pricing?.unit || 'units' %></td></tr>
          <% } %>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="pad">
        <div class="h2">Documents</div>
        <% if (dpp.documents && dpp.documents.length > 0) { %>
          <div class="grid" style="gap: 12px">
            <% dpp.documents.forEach(doc => { %>
              <div class="card" style="box-shadow: none">
                <div class="pad sm">
                  <div class="cardHeader">
                    <div>
                      <div class="h3"><%= doc.name %></div>
                      <p class="p"><%= doc.type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) %></p>
                    </div>
                    <% if (doc.status === 'validated') { %>
                      <span class="badge verified">Validated</span>
                    <% } else if (doc.status === 'pending') { %>
                      <span class="badge warn">Pending</span>
                    <% } else { %>
                      <span class="badge basic">Uploaded</span>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="notice">No documents uploaded yet.</div>
        <% } %>

        <form action="/dpp/<%= dpp.id %>/documents" method="POST" enctype="multipart/form-data" style="margin-top: 12px">
          <div class="field">
            <label>Upload a document</label>
            <input type="file" name="document" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" class="input" />
          </div>
          <div class="row" style="margin-top: 12px">
            <select name="documentType" class="input" style="flex: 1">
              <option value="mill_cert">Mill Certificate</option>
              <option value="calibration_cert">Calibration Certificate</option>
              <option value="capability_statement">Capability Statement</option>
              <option value="ppap">PPAP Package</option>
              <option value="iso_cert">ISO Certificate</option>
              <option value="photo">Photo</option>
              <option value="other">Other</option>
            </select>
            <button type="submit" class="btn">Upload</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <% 
    const ediApplicable = ['raw_material', 'finished_part', 'equipment'].includes(dpp.assetType);
  %>
  <% if (ediApplicable) { %>
    <% if (ediTransactions && ediTransactions.length > 0) { %>
    <div class="card">
      <div class="pad">
        <div class="h2">EDI Transactions</div>
        <div class="grid" style="gap: 12px; margin-top: 16px">
          <% if (ediWorkflow?.purchaseOrder) { %>
            <div class="card" style="box-shadow: none; border: 1px solid #e5e7eb">
              <div class="pad sm">
                <div class="row" style="justify-content: space-between; align-items: center">
                  <div>
                    <div class="h3">850 - Purchase Order</div>
                    <p class="p">Status: <span class="badge"><%= ediWorkflow.purchaseOrder.status %></span></p>
                    <p class="p" style="font-size: 14px; color: #6b7280">
                      <%= new Date(ediWorkflow.purchaseOrder.createdAt).toLocaleDateString() %>
                    </p>
                  </div>
                  <a class="btn" href="/api/edi/<%= ediWorkflow.purchaseOrder.id %>" target="_blank">View</a>
                </div>
              </div>
            </div>
          <% } %>
          <% if (ediWorkflow?.acknowledgment) { %>
            <div class="card" style="box-shadow: none; border: 1px solid #e5e7eb">
              <div class="pad sm">
                <div class="row" style="justify-content: space-between; align-items: center">
                  <div>
                    <div class="h3">855 - PO Acknowledgment</div>
                    <p class="p">Status: <span class="badge verified"><%= ediWorkflow.acknowledgment.status %></span></p>
                    <p class="p" style="font-size: 14px; color: #6b7280">
                      <%= new Date(ediWorkflow.acknowledgment.createdAt).toLocaleDateString() %>
                    </p>
                  </div>
                  <a class="btn" href="/api/edi/<%= ediWorkflow.acknowledgment.id %>" target="_blank">View</a>
                </div>
              </div>
            </div>
          <% } %>
          <% if (ediWorkflow?.shipNotice) { %>
            <div class="card" style="box-shadow: none; border: 1px solid #e5e7eb">
              <div class="pad sm">
                <div class="row" style="justify-content: space-between; align-items: center">
                  <div>
                    <div class="h3">856 - Ship Notice</div>
                    <p class="p">Status: <span class="badge verified"><%= ediWorkflow.shipNotice.status %></span></p>
                    <% if (ediWorkflow.shipNotice.trackingNumber) { %>
                      <p class="p" style="font-size: 14px">Tracking: <%= ediWorkflow.shipNotice.trackingNumber %></p>
                    <% } %>
                  </div>
                  <a class="btn" href="/api/edi/<%= ediWorkflow.shipNotice.id %>" target="_blank">View</a>
                </div>
              </div>
            </div>
          <% } %>
          <% if (ediWorkflow?.invoice) { %>
            <div class="card" style="box-shadow: none; border: 1px solid #e5e7eb">
              <div class="pad sm">
                <div class="row" style="justify-content: space-between; align-items: center">
                  <div>
                    <div class="h3">810 - Invoice</div>
                    <p class="p">Invoice #: <%= ediWorkflow.invoice.invoiceNumber %></p>
                    <p class="p">Total: <%= ediWorkflow.invoice.currency || 'CAD' %> $<%= ediWorkflow.invoice.total?.toLocaleString() || '0' %></p>
                  </div>
                  <a class="btn" href="/api/edi/<%= ediWorkflow.invoice.id %>" target="_blank">View</a>
                </div>
              </div>
            </div>
          <% } %>
          <% if (ediWorkflow?.payment) { %>
            <div class="card" style="box-shadow: none; border: 1px solid #e5e7eb">
              <div class="pad sm">
                <div class="row" style="justify-content: space-between; align-items: center">
                  <div>
                    <div class="h3">820 - Payment Order</div>
                    <p class="p">Amount: <%= ediWorkflow.payment.currency || 'CAD' %> $<%= ediWorkflow.payment.paymentAmount?.toLocaleString() || '0' %></p>
                    <p class="p" style="font-size: 14px; color: #6b7280">
                      <%= new Date(ediWorkflow.payment.paymentDate).toLocaleDateString() %>
                    </p>
                  </div>
                  <a class="btn" href="/api/edi/<%= ediWorkflow.payment.id %>" target="_blank">View</a>
                </div>
              </div>
            </div>
          <% } %>
        </div>
        <div style="margin-top: 16px">
          <button class="btn" onclick="showEDIModal()">Create EDI Transaction</button>
          <a class="btn" href="/api/edi/dpp/<%= dpp.id %>" target="_blank" style="margin-left: 10px">View All EDI</a>
        </div>
      </div>
    </div>
    <% } else { %>
    <div class="card">
      <div class="pad">
        <div class="h2">EDI Transactions</div>
        <div class="notice" style="margin-top: 12px">
          No EDI transactions yet. EDI is available for parts, equipment, and materials.
        </div>
        <div style="margin-top: 16px">
          <button class="btn" onclick="showEDIModal()">Create EDI Transaction</button>
        </div>
      </div>
    </div>
    <% } %>
  <% } %>

  <div class="card">
    <div class="pad">
      <div class="row" style="justify-content: space-between; align-items: center">
        <div>
          <span class="p"><%= dpp.views || 0 %> views • <%= dpp.inquiries || 0 %> inquiries</span>
        </div>
        <div style="display: flex; gap: 10px">
          <a class="btn" href="/dpp/<%= dpp.id %>/edit">Edit Listing</a>
          <% if (!dpp.nafta?.enabled) { %>
            <form action="/nafta/<%= dpp.id %>/enable" method="POST" style="display: inline">
              <button type="submit" class="btn">Enable NAFTA Tracking</button>
            </form>
          <% } %>
          <form action="/dpp/<%= dpp.id %>/delete" method="POST" style="display: inline" onsubmit="return confirmDelete()">
            <button type="submit" class="btn danger">Delete Listing</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- EDI Modal -->
<div id="ediModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 1000; align-items: center; justify-content: center">
  <div class="card" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; background: #ffffff; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3), 0 10px 10px -5px rgba(0,0,0,0.2);">
    <div class="pad">
      <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 20px">
        <div class="h2">Create EDI Transaction</div>
        <button class="btn" onclick="hideEDIModal()">Close</button>
      </div>
      <form id="ediForm" onsubmit="createEDITransaction(event)">
        <div class="field">
          <label>Transaction Type</label>
          <select name="transactionType" class="input" required>
            <option value="850">850 - Purchase Order</option>
            <option value="855">855 - Purchase Order Acknowledgment</option>
            <option value="856">856 - Ship Notice/Manifest</option>
            <option value="810">810 - Invoice</option>
            <option value="820">820 - Payment Order</option>
            <option value="997">997 - Functional Acknowledgment</option>
          </select>
        </div>
        <div class="field">
          <label>
            <input type="checkbox" name="useAI" checked> Use AI to draft transaction
          </label>
        </div>
        <div class="field">
          <label>Notes (optional)</label>
          <textarea name="notes" class="input" rows="3" placeholder="Additional context for AI generation..."></textarea>
        </div>
        <button type="submit" class="btn primary" style="width: 100%; margin-top: 16px">Create Transaction</button>
      </form>
    </div>
  </div>
</div>

<script>
function confirmDelete() {
  return confirm('Are you sure you want to delete this listing? This action cannot be undone.');
}

function showEDIModal() {
  document.getElementById('ediModal').style.display = 'flex';
}

function hideEDIModal() {
  document.getElementById('ediModal').style.display = 'none';
}

async function createEDITransaction(event) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  const transactionType = formData.get('transactionType');
  const useAI = formData.get('useAI') === 'on';
  const notes = formData.get('notes');

  try {
    let response;
    if (useAI) {
      response = await fetch(`/api/edi/<%= dpp.id %>/draft`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          transactionType,
          context: { notes }
        })
      });
    } else {
      response = await fetch('/api/edi', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          dppId: '<%= dpp.id %>',
          transactionType,
          status: 'draft'
        })
      });
    }

    if (response.ok) {
      alert('EDI transaction created successfully!');
      location.reload();
    } else {
      const error = await response.json();
      alert('Error: ' + (error.error || 'Failed to create transaction'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error creating EDI transaction');
  }
}
</script>


